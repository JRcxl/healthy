<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- ä¸Šè¿°3ä¸ªmetaæ ‡ç­¾*å¿…é¡»*æ”¾åœ¨æœ€å‰é¢ï¼Œä»»ä½•å…¶ä»–å†…å®¹éƒ½*å¿…é¡»*è·Ÿéšå…¶åï¼ -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0,user-scalable=no,minimal-ui">
  <meta name="description" content="">
  <meta name="author" content="">
  <link rel="icon" href="../img/asset-favico.ico">
  <title>ä¼ æ™ºå¥åº·</title>
  <link rel="stylesheet" href="../css/page-health-index.css" />
  <link rel="stylesheet" href="../css/page-health-login.css" />
  <link rel="stylesheet" href="../plugins/elementui/index.css" />
  <script src="../plugins/jquery/dist/jquery.min.js"></script>
  <script src="../plugins/healthmobile.js"></script>
  <script src="../plugins/vue/vue.js"></script>
  <script src="../plugins/vue/axios-0.18.0.js"></script>
  <script src="../plugins/elementui/index.js"></script>
  <style>
    .diet-form {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
    }
    .form-section {
      margin-bottom: 20px;
    }
    .el-tag {
      margin-right: 10px;
      margin-bottom: 5px;
    }
    .result-section {
      margin-top: 20px;
      white-space: pre-wrap;
    }
    .meal-list {
      margin-bottom: 30px;
    }

    .meal-card {
      margin-bottom: 20px;
    }

    .meal-name {
      font-weight: bold;
      color: #409EFF;
    }

    .meal-details p {
      margin: 8px 0;
      font-size: 14px;
    }

    .ingredients {
      margin-top: 10px;
    }

    .ingredients .el-tag {
      margin: 2px;
    }

    .warnings {
      margin-top: 25px;
      border-top: 1px solid #eee;
      padding-top: 20px;
    }

    .el-alert {
      margin: 10px 0;
    }
  </style>
</head>
<body data-spy="scroll" data-target="#myNavbar" data-offset="150">
<div class="app" id="app">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <div class="top-header" id="q">
    <span class="f-left"><i class="icon-back" onclick="history.go(-1)"></i></span>
    <span class="center">æ™ºæ…§åŒ»ç–—</span>
    <span class="f-right"><i class="icon-more"></i></span>
  </div>

  <el-card class="diet-form">
    <h2>é¥®é£Ÿè®¡åˆ’ç”Ÿæˆå™¨</h2>
    <el-form :model="formData" label-width="120px" :rules="rules" ref="formRef">
      <!-- åŸºæœ¬ä¿¡æ¯ -->
      <el-card class="form-section">
        <div slot="header">åŸºæœ¬ä¿¡æ¯</div>
        <el-form-item label="ä¼šå‘˜ID" prop="memberId">
          <el-input-number v-model="formData.memberId" :min="93"></el-input-number>
        </el-form-item>
        <el-form-item label="æ€§åˆ«" prop="gender">
          <el-radio-group v-model="formData.gender">
            <el-radio label="ç”·"></el-radio>
            <el-radio label="å¥³"></el-radio>
          </el-radio-group>
        </el-form-item>
        <el-form-item label="ä½“é‡ (kg)" prop="weight">
          <el-input-number v-model="formData.weight" :min="60" :max="200" :precision="1"></el-input-number>
        </el-form-item>
        <el-form-item label="èº«é«˜ (cm)" prop="height">
          <el-input-number v-model="formData.height" :min="160" :max="250" :precision="1"></el-input-number>
        </el-form-item>
      </el-card>

      <!-- åŒ»ç–—ä¿¡æ¯ -->
      <el-card class="form-section">
        <div slot="header">åŒ»ç–—æŠ¥å‘Š</div>
        <el-form-item label="è¡€ç³– (mmol/L)" prop="bloodSugar">
          <el-input-number v-model="formData.bloodSugar" :min="2" :max="30" :precision="1"></el-input-number>
        </el-form-item>
        <el-form-item label="è¡€å‹ (mmHg)" prop="bloodPressure">
          <el-input-number v-model="formData.bloodPressure" :min="50" :max="200" :precision="1"></el-input-number>
        </el-form-item>
      </el-card>

      <!-- è¿‡æ•å’Œç–¾ç—… -->
      <el-card class="form-section">
        <div slot="header">å¥åº·æƒ…å†µ</div>
        <el-form-item label="è¿‡æ•æº">
          <el-tag
                  v-for="(allergy, index) in formData.allergies"
                  :key="index"
                  closable
                  @close="removeTag('allergies', index)">
            {{ allergy }}
          </el-tag>
          <el-input
                  v-model="inputAllergy"
                  placeholder="è¾“å…¥è¿‡æ•æºåæŒ‰å›è½¦"
                  @keyup.enter.native="addTag('allergies', inputAllergy)">
          </el-input>
        </el-form-item>
        <el-form-item label="ç—…å²">
          <el-tag
                  v-for="(disease, index) in formData.diseases"
                  :key="index"
                  closable
                  @close="removeTag('diseases', index)">
            {{ disease }}
          </el-tag>
          <el-input
                  v-model="inputDisease"
                  placeholder="è¾“å…¥ç—…å²åæŒ‰å›è½¦"
                  @keyup.enter.native="addTag('diseases', inputDisease)">
          </el-input>
        </el-form-item>
      </el-card>

      <!-- æäº¤æŒ‰é’® -->
      <el-form-item>
        <el-button type="primary" @click="submitForm">ç”Ÿæˆé¥®é£Ÿè®¡åˆ’</el-button>
        <el-button @click="resetForm">é‡ç½®</el-button>
      </el-form-item>
    </el-form>

</el-card>

  <!-- ç»“æœå±•ç¤º -->
  <el-card class="result-section" v-if="dietPlan">
    <div slot="header">æ‚¨çš„é¥®é£Ÿæ¨è</div>

    <!-- æ¨èé£Ÿè°± -->
    <div class="meal-list">
      <h3>æ¨èé£Ÿè°± ({{ dietPlan.recommendedMeals.length }} æ¬¾)</h3>
      <el-row :gutter="20">
        <el-col :span="8" v-for="(meal, index) in dietPlan.recommendedMeals" :key="index">
          <el-card class="meal-card">
            <div slot="header" class="meal-name">{{ meal.recipe_name }}</div>
            <div class="meal-details">
              <p>ğŸ³ çƒ­é‡: {{ meal.calories }} kcal</p>
              <p>ğŸ§‚ é’ å«é‡: {{ meal.sodium }}mg</p>
              <p>ğŸ’ª è›‹ç™½è´¨: {{ meal.protein }}g</p>
              <div class="ingredients">
                <el-tag
                        v-for="(ingredient, i) in meal.ingredients"
                        :key="i"
                        type="info"
                        size="mini"
                >{{ ingredient }}</el-tag>
              </div>
            </div>
          </el-card>
        </el-col>
      </el-row>
    </div>

    <!-- å¥åº·è­¦å‘Š -->
    <div class="warnings" v-if="dietPlan.warnings.length">
      <h3>âš ï¸ ç‰¹åˆ«æ³¨æ„</h3>
      <el-alert
              v-for="(warning, idx) in dietPlan.warnings"
              :key="idx"
              :title="warning"
              type="warning"
              :closable="false"
              show-icon
      />
    </div>
  </el-card>
</div>

<script>
  new Vue({
    el: '#app',
    data() {
      return {
        formData: {
          memberId: null,
          gender: '',
          weight: null,
          height: null,
          allergies: [],
          diseases: [],
          bloodSugar: null,
          bloodPressure: null
        },
        inputAllergy: '',
        inputDisease: '',
        dietPlan: null,
        rules: {
          memberId: [{ required: true, message: 'è¯·è¾“å…¥ä¼šå‘˜ID', trigger: 'blur' }],
          gender: [{ required: true, message: 'è¯·é€‰æ‹©æ€§åˆ«', trigger: 'change' }],
          weight: [{ required: true, message: 'è¯·è¾“å…¥ä½“é‡', trigger: 'blur' }],
          height: [{ required: true, message: 'è¯·è¾“å…¥èº«é«˜', trigger: 'blur' }],
          bloodSugar: [{ required: true, message: 'è¯·è¾“å…¥è¡€ç³–å€¼', trigger: 'blur' }],
          bloodPressure: [{ required: true, message: 'è¯·è¾“å…¥è¡€å‹å€¼', trigger: 'blur' }]
        }
      }
    },
    methods: {
      addTag(field, value) {
        if (value.trim()) {
          this.formData[field].push(value.trim())
          if (field === 'allergies') this.inputAllergy = ''
          else this.inputDisease = ''
        }
      },
      removeTag(field, index) {
        this.formData[field].splice(index, 1)
      },
      submitForm() {
        this.$refs.formRef.validate(valid => {
          if (valid) {
            axios.post('/recommend.do', {
              memberProfile: {
                memberId: this.formData.memberId,
                gender: this.formData.gender,
                weight: this.formData.weight,
                height: this.formData.height,
                allergies: this.formData.allergies,
                diseases: this.formData.diseases
              },
              medicalReport: {
                bloodSugar: this.formData.bloodSugar,
                bloodPressure: this.formData.bloodPressure
              }
            })
                    .then(response => {
                      this.dietPlan = response.data
                      this.$message.success('é¥®é£Ÿè®¡åˆ’ç”ŸæˆæˆåŠŸï¼')
                    })
                    .catch(error => {
                      this.$message.error('è¯·æ±‚å¤±è´¥: ' + error.message)
                    })
          } else {
            this.$message.error('è¯·å¡«å†™å®Œæ•´è¡¨å•')
          }
        })
      },
      resetForm() {
        this.$refs.formRef.resetFields()
        this.formData.allergies = []
        this.formData.diseases = []
        this.dietPlan = null
      }
    }
  })
</script>

</body>
</html>